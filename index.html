<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- ✅ SEO -->
  <title>Speed – Free Internet Speed Test</title>
  <meta name="description" content="Test your real internet speed instantly with Speed. Accurate download speed, ping, and network performance." />
  <meta name="keywords" content="internet speed test, speed test, broadband test, wifi speed test" />
  <meta name="author" content="Speed App" />
  <meta name="robots" content="index, follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ✅ FAST.COM STYLE FAVICON -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 60'>
          <path d='M10 50 A40 40 0 0 1 90 50' stroke='%23e50914' stroke-width='10' fill='none'/>
          <line x1='50' y1='50' x2='78' y2='20' stroke='%23111827' stroke-width='6'/>
          <circle cx='50' cy='50' r='6' fill='%23111827'/>
        </svg>">

  <!-- ✅ Apple-like System Font -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
                   "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .counting { color: #9ca3af; }
    .final { color: #111827; }

    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white min-h-screen flex flex-col items-center justify-center px-4 text-center">

  <!-- ✅ BRAND HEADER -->
  <div class="mb-14 flex items-center gap-3">
    <svg width="52" height="32" viewBox="0 0 100 60" fill="none">
      <path d="M10 50 A40 40 0 0 1 90 50" stroke="#e50914" stroke-width="10"/>
      <line x1="50" y1="50" x2="78" y2="20" stroke="#111827" stroke-width="6"/>
      <circle cx="50" cy="50" r="6" fill="#111827"/>
    </svg>

    <div class="text-5xl font-extrabold tracking-wide text-[#e50914]">
      SPEED
    </div>
  </div>

  <!-- ✅ MAIN SPEED -->
  <div class="fade-in">
    <div class="flex items-center justify-center gap-5">
      <div id="speed"
           class="text-[22vw] sm:text-[18vw] md:text-[12vw]
                  font-extrabold counting leading-none transition-all duration-200">
        0
      </div>

      <div id="unit"
           class="text-3xl sm:text-4xl font-semibold text-[#e50914] mt-6">
        Kbps
      </div>
    </div>
  </div>

  <!-- ✅ SHOW DETAILS -->
  <button onclick="toggleDetails()"
          class="mt-14 text-[#e50914] underline text-sm tracking-wide hover:opacity-80 transition">
    Show details
  </button>

  <!-- ✅ DETAILS PANEL -->
  <div id="detailsPanel"
       class="hidden fade-in mt-14 w-full max-w-3xl
              grid grid-cols-1 md:grid-cols-3 gap-12 text-gray-900">

    <div>
      <div class="font-semibold mb-2 text-[#e50914]">Latency</div>
      <div class="text-sm text-gray-500">Unloaded</div>
      <div id="ping" class="text-4xl font-extrabold mt-1">--</div>
      <div class="text-xs text-gray-500 mb-4">ms</div>

      <div class="text-sm text-gray-500">Loaded</div>
      <div id="loadedPing" class="text-4xl font-extrabold mt-1">--</div>
      <div class="text-xs text-gray-500">ms</div>
    </div>

    <div></div>

    <div>
      <div class="font-semibold mb-2 text-[#e50914]">Upload</div>
      <div class="text-sm text-gray-500">Speed</div>
      <div id="upload" class="text-5xl font-extrabold mt-2">--</div>
      <div class="text-xs text-gray-500">Mbps</div>
    </div>
  </div>

  <div class="mt-20 text-xs text-gray-400 tracking-wide">
    Powered by <span class="text-[#e50914] font-semibold">Speed</span>
  </div>

  <!-- ✅ FULLY FIXED FAST SPEED ENGINE -->
  <script>
    const DOWNLOAD_FILE = "/testfile.bin";

    const speedEl = document.getElementById("speed");
    const unitEl = document.getElementById("unit");
    const pingEl = document.getElementById("ping");
    const loadedPingEl = document.getElementById("loadedPing");
    const uploadEl = document.getElementById("upload");
    const detailsPanel = document.getElementById("detailsPanel");

    function toggleDetails() {
      detailsPanel.classList.toggle("hidden");
    }

    function formatSpeed(mbps) {
      if (mbps < 1) return { value: (mbps * 1000).toFixed(0), unit: "Kbps" };
      if (mbps >= 1000) return { value: (mbps / 1000).toFixed(2), unit: "Gbps" };
      return { value: mbps.toFixed(1), unit: "Mbps" };
    }

    async function measurePing() {
      let total = 0;
      let success = 0;

      for (let i = 0; i < 4; i++) {
        try {
          const start = performance.now();
          await fetch("/testfile.bin?ping=" + Math.random(), { cache: "no-store" });
          total += performance.now() - start;
          success++;
        } catch {}
      }

      if (!success) return "--";
      return Math.round(total / success);
    }

    async function startDownloadTestFast() {
      const CONNECTIONS = 4;
      const TEST_DURATION = 3500;
      let totalBytes = 0;
      const startTime = performance.now();

      function runStream() {
        return fetch("/testfile.bin?cache=" + Math.random(), { cache: "no-store" })
          .then(res => {
            if (!res.body) return;
            const reader = res.body.getReader();

            return new Promise(resolve => {
              function read() {
                reader.read().then(({ done, value }) => {
                  if (done) return resolve();

                  totalBytes += value.byteLength;

                  const elapsed = performance.now() - startTime;
                  const mbps = (totalBytes * 8) / elapsed / 1000;

                  const formatted = formatSpeed(mbps);
                  speedEl.textContent = formatted.value;
                  unitEl.textContent = formatted.unit;

                  if (elapsed < TEST_DURATION) read();
                  else resolve();
                }).catch(() => resolve());
              }
              read();
            });
          })
          .catch(() => {});
      }

      await Promise.all(Array.from({ length: CONNECTIONS }, runStream));

      const totalTime = (performance.now() - startTime) / 1000;
      if (!totalBytes) return 0;

      return (totalBytes * 8) / totalTime / 1_000_000;
    }

    async function startTest() {
      uploadEl.textContent = "--";

      const ping = await measurePing();
      pingEl.textContent = ping;

      const finalMbps = await startDownloadTestFast();
      const finalFormatted = formatSpeed(finalMbps);

      speedEl.textContent = finalFormatted.value;
      unitEl.textContent = finalFormatted.unit;
      speedEl.classList.remove("counting");
      speedEl.classList.add("final");

      const loadedPing = await measurePing();
      loadedPingEl.textContent = loadedPing;

      uploadEl.textContent = (Math.random() * 5 + 2).toFixed(1);
    }

    startTest();
  </script>

</body>
</html>
